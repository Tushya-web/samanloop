{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SamanLoop â€“ Reset Password</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">

<style>
:root {
  --brand-teal: #0d9488;
  --brand-hover: #0f766e;
  --navy-dark: #0f172a;
  --border-subtle: #e2e8f0;
  --text-muted: #64748b;
}

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(13, 148, 136, 0.7)),
              url("{% static 'images/login-bg.png' %}");
  background-size: cover; background-position: center;
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  margin: 0; padding: 20px;
}

.card {
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(12px);
  width: 100%; max-width: 420px;
  padding: 2.8rem 2.2rem; border-radius: 30px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,.3);
}

.logo { text-align: center; margin-bottom: 1.4rem; }
.logo img { height: 44px; }

h3 { text-align: center; font-weight: 800; margin: .5rem 0 .2rem; color: var(--navy-dark); }
p.subtitle { text-align: center; color: var(--text-muted); font-size: .92rem; margin-bottom: 1.5rem; }

/* Input & Loader Styles */
.input-group { position: relative; margin: 1.2rem 0; }
.input-group i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.form-control {
  width: 100%; padding: 14px 14px 14px 50px; border-radius: 14px;
  border: 1.5px solid var(--border-subtle); background: #f8fafc; box-sizing: border-box; transition: 0.3s;
}
.form-control:focus { outline: none; border-color: var(--brand-teal); background: #fff; }

.btn {
  width: 100%; background: var(--brand-teal); border: none; padding: 16px;
  color: white; font-weight: 700; border-radius: 14px; cursor: pointer; transition: 0.3s;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.btn:disabled { background: #cbd5e1; cursor: not-allowed; }

.loader {
  width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent;
  border-radius: 50%; display: none; animation: rotation 1s linear infinite;
}
@keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Success State Styles */
#successState { display: none; text-align: center; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.spam-box {
  background: #f0fdfa; border: 1px solid #ccfbf1; padding: 12px;
  border-radius: 12px; color: #0d9488; font-size: 0.85rem; margin: 20px 0;
}
.redirect-text { font-size: 0.85rem; color: var(--text-muted); margin-top: 15px; }

.links { text-align: center; margin-top: 1.5rem; font-size: .9rem; }
.links a { color: var(--brand-teal); text-decoration: none; font-weight: 700; }
</style>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>

const firebaseConfig = {
    "apiKey": os.getenv("FIREBASE_API_KEY"),
    "authDomain": os.getenv("FIREBASE_AUTH_DOMAIN"),
    "projectId": os.getenv("FIREBASE_PROJECT_ID"),
};

firebase.initializeApp(firebaseConfig);

function resetPassword(e) {
    e.preventDefault();

    const email = document.getElementById("emailInput").value;

    if (!email) {
        alert("Enter email first");
        return;
    }

    firebase.auth()
      .sendPasswordResetEmail(email)
      .then(() => {

          // SHOW SUCCESS UI ONLY AFTER REAL FIREBASE SUCCESS
          document.getElementById('formState').style.display = 'none';
          document.getElementById('successState').style.display = 'block';
          document.getElementById('targetEmail').innerText = email;

          startRedirection();
          startCooldown();

      })
      .catch(err => {
          alert(err.message);
      });
}
</script>
</head>

<body>

<div class="card">
  <div class="logo">
    <a href="{% url 'index' %}">
      <img src="{% static 'images/logo.png' %}" alt="logo">
    </a>
  </div>

  <div id="formState">
    <h3>Reset Password</h3>
    <p class="subtitle">Enter your email and we'll send a reset link</p>

    <form method="POST" onsubmit="resetPassword(event)">
      {% csrf_token %}
      <div class="input-group">
        <i class="bi bi-envelope"></i>
        <input name="email" type="email" id="emailInput" class="form-control" placeholder="Registered email" required>
      </div>

      <button type="submit" class="btn" id="submitBtn">
        <span id="btnText">Send Reset Link</span>
        <div class="loader" id="btnLoader"></div>
      </button>
    </form>
  </div>

  <div id="successState">
    <div style="background: #0d9488; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
      <i class="bi bi-check-lg" style="color: white; font-size: 2rem;"></i>
    </div>
    <h3>Email Sent!</h3>
    <p class="subtitle">A reset link has been sent to <br><b id="targetEmail" style="color: var(--navy-dark);">user@email.com</b></p>
    
    <div class="spam-box">
      <i class="bi bi-info-circle-fill"></i> <b>Check Spam:</b> If you don't see the email, please check your spam or junk folder.
    </div>

    <button id="resendBtn" class="btn" disabled style="background: #f1f5f9; color: var(--text-muted); border: 1px solid var(--border-subtle);">
      Resend Link (<span id="cooldown">30</span>s)
    </button>

    <p class="redirect-text">Redirecting to login in <span id="timer">5</span>s...</p>
  </div>

  <div class="links">
    <a href="/login/">Back to login</a>
  </div>
</div>

<script>
function handleReset(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  const btnText = document.getElementById('btnText');
  const loader = document.getElementById('btnLoader');
  const email = document.getElementById('emailInput').value;

  // Start Loader
  btn.disabled = true;
  btnText.innerText = "Processing...";
  loader.style.display = "inline-block";

  // Simulate API Call
  setTimeout(() => {
    document.getElementById('formState').style.display = 'none';
    document.getElementById('successState').style.display = 'block';
    document.getElementById('targetEmail').innerText = email;
    
    startRedirection();
    startCooldown();
  }, 1500);
}

function startRedirection() {
  let timeLeft = 5;
  const timerDisplay = document.getElementById('timer');
  const interval = setInterval(() => {
    timeLeft--;
    timerDisplay.innerText = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(interval);
      window.location.href = "/login/";
    }
  }, 5000);
}

function startCooldown() {
  let cooldown = 30;
  const resendBtn = document.getElementById('resendBtn');
  const cooldownDisplay = document.getElementById('cooldown');

  const interval = setInterval(() => {
    cooldown--;
    cooldownDisplay.innerText = cooldown;
    if (cooldown <= 0) {
      clearInterval(interval);
      resendBtn.disabled = false;
      resendBtn.innerText = "Resend Link";
      resendBtn.style.background = "white";
      resendBtn.style.color = "var(--brand-teal)";
      resendBtn.style.borderColor = "var(--brand-teal)";
    }
  }, 1000);
}
</script>

</body>
</html>