{%load static %}
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    :root {
        --brand-teal: #20c997;
        --brand-teal-dark: #1ba87e;
        --navy-dark: #0a192f;
        --soft-gray: #f8fafc;
    }

    body {
        background: radial-gradient(circle at top right, #e2f9f3, #f8fafc);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .location-card {
        background: white;
        border-radius: 32px;
        padding: 40px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.05);
        max-width: 500px;
        width: 100%;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.8);
    }

    .logo-wrapper { margin-bottom: 30px; }
    
    .loc-icon-circle {
        width: 80px;
        height: 80px;
        background: rgba(32, 201, 151, 0.1);
        color: var(--brand-teal);
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    h3 { font-weight: 800; color: var(--navy-dark); margin-bottom: 10px; }
    p.subtitle { color: #64748b; font-size: 0.95rem; margin-bottom: 30px; }

    /* Auto Detect Button */
    .btn-detect {
        width: 100%;
        background: var(--navy-dark);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: 0.3s;
        margin-bottom: 25px;
    }
    .btn-detect:hover { transform: translateY(-2px); background: #162a4a; box-shadow: 0 10px 20px rgba(10, 25, 47, 0.2); }

    .divider {
        display: flex;
        align-items: center;
        text-align: center;
        color: #cbd5e1;
        margin: 25px 0;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #e2e8f0; }
    .divider:not(:empty)::before { margin-right: 15px; }
    .divider:not(:empty)::after { margin-left: 15px; }

    /* Custom Select Styling */
    .select-wrapper {
        position: relative;
        margin-bottom: 20px;
    }
    .city-select {
        width: 100%;
        appearance: none;
        background: var(--soft-gray);
        border: 2px solid #e2e8f0;
        padding: 16px 20px;
        border-radius: 18px;
        font-weight: 600;
        color: var(--navy-dark);
        cursor: pointer;
        transition: 0.2s;
    }
    .city-select:focus { outline: none; border-color: var(--brand-teal); background: white; }

    .btn-continue {
        width: 100%;
        background: var(--brand-teal);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 18px;
        font-weight: 700;
        font-size: 1.1rem;
        transition: 0.3s;
    }
    .btn-continue:hover { background: var(--brand-teal-dark); transform: translateY(-2px); }

    /* Loading Spinner */
    .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="location-card">
    <div class="logo-wrapper">
        <img src="{% static 'images/logo.png' %}" alt="SamanLoop" style="height: 35px;">
    </div>

    <div class="loc-icon-circle">
        <i data-lucide="map-pin" style="width: 32px; height: 32px;"></i>
    </div>

    <h3>Where are you?</h3>
    <p class="subtitle">Select your city to see items available for rent near you.</p>

    <button type="button" class="btn-detect" id="detectBtn" onclick="detectLocation()">
        <i data-lucide="navigation" style="width: 20px; height: 20px;"></i>
        <span id="btnText">Use Current Location</span>
        <div class="spinner" id="btnSpinner"></div>
    </button>

    <div class="divider">Or select manually</div>

    <form method="POST" id="manualLocationForm">
        {% csrf_token %}
        <div class="select-wrapper">
            <select name="city" class="city-select">
                <option value="" disabled selected>Choose your city...</option>
                {% for city in allowed_cities %}
                    <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn-continue">
            Continue <i data-lucide="arrow-right" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-left: 5px;"></i>
        </button>
    </form>
</div>
<script>
// Initialize Lucide Icons
lucide.createIcons();

function detectLocation() {
    const btn = document.getElementById('detectBtn');
    const text = document.getElementById('btnText');
    const spinner = document.getElementById('btnSpinner');

    // Visual Loading State
    btn.disabled = true;
    text.innerText = "Finding you...";
    spinner.style.display = "block";

    if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        resetBtn();
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
            .then(response => response.json())
            .then(data => {
                let city = data.address.city || data.address.town || data.address.village || data.address.suburb;
                
                // Final validation with backend
                fetch("/validate-location/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ city: city })
                })
                .then(res => res.json())
                .then(result => {
                    if(result.status === "ok"){
                        window.location.href = "/profile/";
                    } else {
                        alert(`We haven't launched in ${city} yet. Please choose a supported city.`);
                        resetBtn();
                    }
                })
                .catch(err => {
                    console.error(err);
                    resetBtn();
                });
            });
        },
        function(error) {
            alert("Location access denied. Please select your city manually.");
            resetBtn();
        }
    );

    function resetBtn() {
        btn.disabled = false;
        text.innerText = "Use Current Location";
        spinner.style.display = "none";
    }
}

</script>